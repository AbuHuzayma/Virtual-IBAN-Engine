# Virtual IBAN Engine â€” Requirements, Design & API Specification

---

## 1. Goal (one-line)

**Provide a robust, auditable engine for creating and managing Virtual IBANs for merchants, keeping per-merchant pool account balances and transactions, integrating with Temenos T24 for inter-pool/real bank transfers, and exposing merchant APIs.**

---

## 2. Actors

* **Merchant** â€” owns one Pool Account and many Virtual IBANs.
* **Virtual IBAN** â€” internal identifier mapped to a merchant; used to receive/pay funds.
* **Engine** â€” manages virtual ledger, balances, API, business rules, and T24 integration.
* **Temenos T24 (T24)** â€” core banking system that executes inter-pool (real bank) transfers when needed.
* **Admin / Ops** â€” system operators for reconciliation, monitoring, reporting.

---

## 3. High-level Functional Requirements

### 3.1 Pool Account per Merchant
* Each merchant has one pool account in the bank (T24-managed real pool account).

### 3.2 Virtual IBANs
* Create single and bulk Virtual IBANs per merchant.
* Metadata: name, notes, status (active/blocked/closed), createdAt, tags.

### 3.3 Balances & Transactions

Engine maintains ledger for:
* Virtual IBAN balances.
* Pool account balance (reflects sum of virtual IBANs + pending).

Transactions can be:
* **Internal**: Virtual IBAN â†’ Virtual IBAN (same pool) â€” handled internally by engine.
* **External**: Virtual IBAN â†’ Virtual IBAN (different pool) â€” engine must call T24 to execute, then reflect balances.
* **Credit IBAN** (external deposit / top-up) â€” engine receives credit events and credits a Virtual IBAN.
* **Debit / Payout** â€” trigger T24 if funds leave the pooled network.

### 3.4 T24 Integration
* Engine issues transfer requests to T24 for cross-pool transactions / settlement.
* Engine consumes T24 callbacks / notifications (webhooks) to confirm settlement and update ledger.

### 3.5 Merchant APIs
* Create IBAN (single & batch).
* Transfer money between Virtual IBANs.
* Credit IBAN.
* Statement inquiry by Virtual IBAN or Merchant (Pool) with pagination/filters.
* Additional recommended APIs (see section 7).

### 3.6 Accounting Principles
* Use double-entry ledger model to guarantee consistency and auditability.
* Idempotency on all money-moving operations.

### 3.7 Operational
* Reconciliation process with T24, audit logs, and admin reports.

---

## 4. Non-functional Requirements

* **Consistency & Correctness**: Strong consistency for ledger operations, atomic transfers.
* **Durability**: All transactions persisted and replicated.
* **Scalability**: Handle thousands of virtual IBANs per merchant and high Tx/sec for transfers.
* **Performance**: Internal (same pool) transfers: sub-100ms typical. External: depends on T24.
* **Availability**: 99.9%+; scheduled maintenance windows.
* **Security & Compliance**: TLS, mTLS for T24, OAuth2/JWT for merchant APIs, PCI/AML/KYC controls where applicable.
* **Observability**: Audit trail, metrics, tracing, alerting.
* **Idempotency**: Transaction endpoints must be idempotent via idempotency keys.
* **Concurrency control**: Use optimistic locking or ledger-based atomic operations.

---

## 5. Important Business & Technical Assumptions

* Each merchant has exactly one bank pool account in T24.
* T24 is the source of truth for *real* bank balances; the engine holds an internal representation that is reconciled to T24.
* IBAN generation may either be produced by T24 or generated by the engine following bank-approved formats (confirm with bank). (If T24 issues IBANs, the engine should request them from T24.)
* T24 supports synchronous API calls for transfers and asynchronous callbacks for settlement status.
* All currency handling uses ISO-4217 codes; multi-currency support recommended (explicit about FX outside scope unless required).

---

## 6. Core Design & Ledger Model

### 6.1 System Architecture Overview

![System Architecture Diagram](./images/diagrams/01_architecture.png)

**Diagram 1: System Architecture**

### 6.2 Double-entry Ledger (Recommended)

Maintain a ledger of accounting entries:

Table: `ledger_entries` with:
* `id`, `transaction_id`, `timestamp`, `account_type` (VIRTUAL_IBAN | POOL_ACCOUNT | T24_HOLD), `account_id` (virtual_iban_id or pool_account_id), `debit`, `credit`, `balance_after`, `narration`, `metadata`.

A transfer is implemented as *two* ledger entries: debit one account, credit the other â€” grouped by `transaction_id`. This guarantees traceability and enables reconciliation.

### 6.3 Concurrency & Balance Checks

* For internal transfers: perform atomic debit+credit in a DB transaction with serializable or repeatable-read isolation or using optimistic locking (version field).
* Use *reserve* / *hold* entries for pending external transfers (to avoid double spending while waiting for T24).

### 6.4 Database Schema (ERD)

![Database ERD Diagram](./images/diagrams/04_database_erd.png)

**Diagram 4: Database ERD**

---

## 7. Suggested API Surface (REST JSON)

Base: `https://api.example.com/v1`

![Merchant API Interaction Flow](./images/diagrams/06_merchant_api_flow.png)

**Diagram 6: Merchant API Interaction Flow**

### 7.1 Authentication & Headers

* `Authorization: Bearer <JWT>`
* `Idempotency-Key: <uuid>` for money-moving endpoints (create transfers, credit).
* `X-Request-ID: <uuid>` optional for tracing.
* `Accept: application/json`, `Content-Type: application/json`

### 7.2 Create Single Virtual IBAN

`POST /merchants/{merchantId}/virtual-ibans`

**Request:**
```json
{
  "name": "Customer Acct 1001",
  "notes": "Payroll account for project X",
  "currency": "EUR",
  "metadata": {"customerRef": "CUST-1001"}
}
```

**Response 201:**
```json
{
  "virtualIbanId": "viban_123",
  "iban": "GB33BUKB20201555555555",
  "merchantId": "m_123",
  "status": "ACTIVE",
  "createdAt": "2025-10-28T12:00:00Z"
}
```

### 7.3 Create Bulk Virtual IBANs

`POST /merchants/{merchantId}/virtual-ibans/bulk`

**Request:**
```json
{
  "items": [
    {"name":"A","notes":"n","currency":"EUR"},
    {"name":"B","notes":"n2","currency":"EUR"}
  ]
}
```

**Response 200:**
```json
{
  "results": [
    {"index":0, "status":"CREATED", "virtualIbanId":"v_1", "iban":"..."},
    {"index":1, "status":"CREATED", "virtualIbanId":"v_2", "iban":"..."}
  ]
}
```

Bulk operations should be **asynchronous** if creating many IBANs; include `operationId` and `GET /operations/{operationId}`.

### 7.4 Get Virtual IBAN Details

`GET /virtual-ibans/{virtualIbanId}`

**Response:**
```json
{
  "virtualIbanId":"v_123",
  "iban":"GBxx...",
  "merchantId":"m_123",
  "status":"ACTIVE",
  "balance": {"amount": 1000.00, "currency":"EUR"},
  "createdAt":"..."
}
```

### 7.5 Money Transfer Between Virtual IBANs

`POST /transfers`

**Request:**
```json
{
  "fromVirtualIbanId": "v_abc",
  "toVirtualIbanId": "v_def",
  "amount": 250.00,
  "currency": "EUR",
  "reference": "INV-2025-001",
  "metadata": {"orderId":"O123"}
}
```

**Behavior:**
* If both IBANs belong to same merchant/pool â†’ engine executes internal transfer (no T24 call).
* If belong to different merchants/pools â†’ engine:
  * Create a pending ledger hold debit on source virtual IBAN and pool.
  * Call T24 transfer API to move funds from source pool to destination pool (or make appropriate clearing).
  * On T24 success callback, create credit ledger entries and release holds; on failure, rollback holds and notify.

**Response (accepted / 201):**
```json
{
  "transactionId": "tx_123",
  "status": "PENDING",
  "fromBalanceAfter": {"amount": 750.00, "currency":"EUR"}
}
```

### 7.6 Credit IBAN (External Deposit / Top-up)

`POST /virtual-ibans/{virtualIbanId}/credit`

**Request:**
```json
{
  "amount": 500.00,
  "currency": "EUR",
  "source": {"type":"BANK_INCOMING", "reference":"bankRef123"},
  "metadata": {}
}
```

Typically flows from T24 inbound notification; endpoint can be used by bank webhook to credit an IBAN.

**Response 200:**
```json
{"transactionId":"tx_cred_1","status":"COMPLETED"}
```

### 7.7 Statement / Transactions Inquiry by Virtual IBAN

`GET /virtual-ibans/{virtualIbanId}/statements?from=2025-01-01&to=2025-10-28&page=1&size=50`

**Response:**
```json
{
  "virtualIbanId":"v_123",
  "balance": {...},
  "transactions": [
    {"transactionId":"tx1","timestamp":"...","type":"CREDIT","amount":100.00,"balanceAfter":100.00,"narration":"..."},
    ...
  ],
  "page":1,"size":50,"total":125
}
```

### 7.8 Statement / Transactions Inquiry by Merchant (Pool Account)

`GET /merchants/{merchantId}/pool-account/statements?from=...&to=...`

Returns pool-level ledger (summary & transactions) + aggregated balances across IBANs.

### 7.9 Additional Recommended APIs

* `GET /merchants/{merchantId}/virtual-ibans` (list with filters)
* `PATCH /virtual-ibans/{id}` (update name, notes, status: BLOCK/UNBLOCK/CLOSE)
* `POST /transfers/{transactionId}/cancel` (cancel pending transfer if rules allow)
* Webhook endpoints:
  * `POST /webhooks/t24/transfer-status` â€” inbound T24 notifications (signed).
* Admin:
  * `GET /admin/reconciliation/{merchantId}?date=2025-10-28`
  * `GET /audit/transactions/{transactionId}`

> **ðŸ“Š Diagram 6: Merchant API Interaction Flow**  
> *Source: `diagrams/06_merchant_api_flow.puml`*  
> *Render at: https://www.plantuml.com/plantuml/*

---

## 8. Data Model (Tables)

### merchants
* `merchant_id` (PK), `name`, `pool_account_id` (FK), `currency`, `created_at`, `metadata(json)`

### pool_accounts
* `pool_account_id` (PK), `merchant_id` (FK), `bank_account_ref` (T24 ID), `balance_amount`, `currency`, `last_reconciled_at`

### virtual_ibans
* `virtual_iban_id` (PK), `merchant_id` (FK), `iban` (unique), `name`, `status`, `currency`, `created_at`, `metadata`

### ledger_entries
* `entry_id` (PK), `transaction_id` (grouping), `account_type` (VIRTUAL_IBAN|POOL), `account_id`, `debit`, `credit`, `balance_after`, `timestamp`, `narration`, `metadata`

### transactions (logical)
* `transaction_id` (PK), `type` (INTERNAL|OUTBOUND|INBOUND), `status` (PENDING|COMPLETED|FAILED|CANCELLED), `from_account`, `to_account`, `amount`, `currency`, `created_at`, `updated_at`, `idempotency_key`, `t24_ref`

### t24_events (store callbacks)
* `t24_event_id`, `payload`, `received_at`, `status`, `processed_at`, `related_transaction_id`

### audit_log
* `id`, `actor`, `action`, `target`, `payload`, `timestamp`

---

## 9. Key Workflows (Sequence Summary)

### 9.1 Internal Transfer (Same Pool)

![Internal Transfer Sequence](./images/diagrams/02_internal_transfer.png)

**Diagram 2: Internal Transfer Sequence (Same Pool)**

**Detailed Steps:**
1. API `POST /transfers`
2. Validate IDs, currencies, sufficient balance.
3. DB Txn:
   * Create `transaction` record (COMPLETED).
   * Insert two `ledger_entries` (debit source, credit dest).
   * Update cached balances (or compute from ledger).
4. Return `COMPLETED` with balances.

### 9.2 External Transfer (Different Pools) â€” Optimistic Pattern

![External Transfer Sequence](./images/diagrams/03_external_transfer.png)

**Diagram 3: External Transfer Sequence (Cross-Pool via T24)**

**Detailed Steps:**
1. API `POST /transfers` â†’ create `transaction` with `PENDING`.
2. DB Txn:
   * Create hold/debit entry on source virtual IBAN and reduce available balance.
   * Create pending ledger entry for T24 (status PENDING).
3. Call T24 API (synchronous request or an outbound message to bank).
4. On T24 success:
   * Create credit ledger entries on destination pool/virtual IBAN.
   * Mark `transaction` as `COMPLETED`, link T24 ref.
5. On T24 failure/timeouts:
   * Release hold, mark `transaction` as FAILED, write error reasons.
6. Ensure idempotency (T24 may call callback later â€” match by `transaction_id`/`t24_ref`/`idempotency_key`).

### 9.3 Incoming Bank Deposit (Credit IBAN)

* T24 notifies engine (webhook) with `bank_ref`, `destination_pool`, `amount`.
* Engine maps incoming to `virtual_iban` (via IBAN) and creates `COMPLETED` ledger credit entry.

---

## 10. Error Handling & Statuses

* Use standard HTTP codes:
  * `200` OK, `201` Created, `202` Accepted (async), `400` Bad Request, `401` Unauthorized, `403` Forbidden, `404` Not Found, `409` Conflict (insufficient funds or version conflict), `422` Unprocessable (validation), `500` Internal.
* Business error codes in body:
```json
{"code":"INSUFFICIENT_FUNDS","message":"Insufficient available balance.","details":{}}
```
* For money-moving endpoints, 409 on insufficient funds; 202 Accepted when external transfer queued.

---

## 11. Idempotency & Duplicate Prevention

* Require `Idempotency-Key` header for all POST operations that change money state.
* Store idempotency record: `{key, request_hash, result, created_at}`; reuse result on repeated requests.
* Enforce idempotency window (e.g., 24 hours or configurable).

---

## 12. Security & Compliance

* TLS 1.3 for all traffic.
* OAuth 2.0 / JWT for merchants, with scopes:
  * `viban.read`, `viban.write`, `transfers.create`, `transfers.read`, `admin.*`
* mTLS for T24 integration & webhooks (mutual TLS + HMAC signatures).
* Role-based access for admin endpoints.
* Audit log every change (who, what, when).
* Rate limiting: default 100 req/min per merchant; adjustable.
* Data encryption at rest (sensitive metadata), and in transit.
* Log masking for PII.
* AML & KYC hooks: suspicious transaction flags, limits, and blocking.

---

## 13. Reconciliation & Admin Processes

![Reconciliation Flow](./images/diagrams/05_reconciliation.png)

**Diagram 5: Reconciliation Flow (T24 â†” Engine)**

### 13.1 Daily Reconciliation Job

**Daily reconciliation job:**
* Pull T24 statements for each pool account.
* Match T24 transfers to engine transactions (by `t24_ref`, amount, timestamp).
* Generate reconciliation reports: matched / unmatched / outstanding holds.

### 13.2 Exception Handling & Auditing

**Exceptions:** operations team resolves unmatched items; a manual settle/correct endpoint available.

**Auditing:** immutable audit trail + ability to export per merchant.

### 13.3 Webhooks & Notifications

![Webhooks & Notification Flow](./images/diagrams/07_webhooks.png)

**Diagram 7: Webhooks & Notification Flow**

---

## 14. Monitoring & Observability

* Metrics: tx/sec, pending external transfers, reconciliation mismatch count, error rates, latency.
* Tracing: distributed traces for flow across engine â†’ T24.
* Alerts: failed reconciliation > threshold, transfer failure rate spike, P99 latency > threshold.
* Logs stored centrally and searchable with structured fields (transactionId, merchantId, iban).

---

## 15. Testing & QA Checklist

* Unit tests on ledger logic.
* Integration tests for internal transfers (concurrency stress tests).
* End-to-end tests simulating T24 success/failures (stubs/mocks).
* Idempotency tests (replay same request).
* Reconciliation scenarios with missing T24 callbacks.
* Security tests: auth, roles, rate limits, input validation, pen tests.
* Load tests: simulate realistic merchant volumes and bursts.

---

## 16. Operational & Deployment Notes

* Deploy as microservice with database (Postgres recommended) and job workers for async tasks and reconciliation.
* Use Kafka or message queue for communication to/from T24 to avoid single-point failures.
* Database: use migrations and backups; enable point-in-time recovery.
* Consider read replicas for read-heavy statement queries.
* Provide a sandbox environment for merchants + T24 integration testing.

---

## 17. Example SQL Snippets (Postgres)

```sql
CREATE TABLE merchants (
  merchant_id uuid PRIMARY KEY,
  name text NOT NULL,
  pool_account_id uuid,
  created_at timestamptz DEFAULT now(),
  metadata jsonb DEFAULT '{}'
);

CREATE TABLE virtual_ibans (
  virtual_iban_id uuid PRIMARY KEY,
  merchant_id uuid REFERENCES merchants(merchant_id),
  iban text UNIQUE NOT NULL,
  name text,
  status text NOT NULL DEFAULT 'ACTIVE',
  currency char(3) NOT NULL,
  created_at timestamptz DEFAULT now(),
  metadata jsonb DEFAULT '{}'
);

CREATE TABLE transactions (
  transaction_id uuid PRIMARY KEY,
  type text NOT NULL,
  status text NOT NULL,
  from_account text,
  to_account text,
  amount numeric(20,4) NOT NULL,
  currency char(3) NOT NULL,
  idempotency_key text,
  t24_ref text,
  created_at timestamptz DEFAULT now(),
  updated_at timestamptz DEFAULT now()
);

CREATE TABLE ledger_entries (
  entry_id uuid PRIMARY KEY,
  transaction_id uuid REFERENCES transactions(transaction_id),
  account_type text NOT NULL,
  account_id uuid,
  debit numeric(20,4) DEFAULT 0,
  credit numeric(20,4) DEFAULT 0,
  balance_after numeric(20,4),
  timestamp timestamptz DEFAULT now(),
  narration text,
  metadata jsonb DEFAULT '{}'
);
```

---

## 18. Edge Cases, Checks & Recommendations (Must-have)

* **Currency mismatch**: reject or route through FX (out of scope unless required).
* **Blocked IBANs**: block movement and trigger alerts; admin can unblock.
* **Partial failures**: ensure rollback semantics; if T24 call succeeds but webhook lost, use reconciliation to finalize.
* **Clock skew**: use UTC timestamps; reconcile time windows.
* **Eventual consistent caches**: don't rely on cached balance for authorizing transfers unless consistent guarantee provided.
* **Limits**: per-transaction & daily limits per merchant and per IBAN configurable.
* **Privacy**: do not expose full IBAN in logs; mask where possible.

---

## 19. Diagram Reference

All diagrams are now integrated into their relevant sections throughout this document:
* **Diagram 1 (Section 6.1)**: System Architecture Overview
* **Diagram 2 (Section 9.1)**: Internal Transfer Sequence
* **Diagram 3 (Section 9.2)**: External Transfer Sequence
* **Diagram 4 (Section 6.4)**: Database ERD
* **Diagram 5 (Section 13)**: Reconciliation Flow
* **Diagram 6 (Section 7)**: Merchant API Interaction Flow
* **Diagram 7 (Section 13.3)**: Webhooks & Notification Flow

**PlantUML Source Files:** All diagram sources are available in the `diagrams/` directory for rendering.

**How to Render:** Visit https://www.plantuml.com/plantuml/, paste the content from any `.puml` file, and export as PNG or SVG.

---

## 20. Roadmap & Optional Features

* **Webhooks for merchants**: on transaction status updates.
* **Batch payouts**: merchants upload batch files for payouts, engine executes and tracks.
* **Reporting portal**: for statements, reconciliation, KYC status.
* **Rate limits & quotas** management per merchant.
* **GraphQL** alternative for rich queries (optional).
* **Multi-currency & FX** support.

---

## 21. Deliverables & Next Steps (Recommended)

1. Confirm assumptions about IBAN issuance (engine vs T24).
2. Define exact T24 APIs: endpoints, auth, message formats, callback behavior (we will create adapter).
3. Finalize currency/FX requirements and AML/KYC rules.
4. Build minimal MVP APIs: create IBAN, internal transfer, statement inquiry, T24 integration stub.
5. Implement ledger-first model, idempotency, reconciliation worker.
6. Create test harness for T24 simulation.

---

## 22. Summary Validation Checklist

* [ ] Single pool per merchant â€” confirmed requirement.
* [ ] Engine handles internal transfers internally.
* [ ] Engine calls T24 for cross-pool transfers and reflects the balances.
* [ ] APIs for create (single/bulk), transfer, credit, statements implemented.
* [ ] Double-entry ledger, idempotency, reconciliation, monitoring, security in place.

